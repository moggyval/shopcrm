{% extends "base.html" %}
{% block content %}
<div class="row space">
  <h2>Calendar</h2>
  <div class="row gap">
    <a class="btn" href="{{ url_for('ro_new') }}">+ New RO</a>
  </div>
</div>

<div class="card">
  <div id="calendar"></div>
</div>

<div class="modal" id="apptModal">
  <div class="modalCard">
    <div class="row space">
      <h3 id="apptTitle">Appointment</h3>
      <button class="btn tiny" type="button" onclick="closeAppt()">X</button>
    </div>

    <form method="post" id="apptForm">
      <input type="hidden" name="appt_id" id="appt_id">
      <div class="grid2">
        <div>
          <label>RO</label>
          <select name="ro_id" id="ro_id">
            {% for r in ro_pick %}
              <option value="{{ r.id }}">#{{ r.ro_number }} â€” {{ r.customer_name }} ({{ r.vehicle_text }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Title</label>
          <input name="title" id="title" placeholder="Diag, brakes, starter..." required>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Start</label>
          <input name="start_at" id="start_at" type="datetime-local" required>
        </div>
        <div>
          <label>End</label>
          <input name="end_at" id="end_at" type="datetime-local" required>
        </div>
      </div>

      <label>Status</label>
      <select name="status" id="status">
        <option value="scheduled">scheduled</option>
        <option value="in_progress">in_progress</option>
        <option value="done">done</option>
        <option value="canceled">canceled</option>
      </select>

      <label>Notes</label>
      <textarea name="notes" id="notes" rows="3"></textarea>

      <div class="row gap" style="margin-top:12px;">
        <button class="btn primary" type="submit">Save</button>
        <button class="btn" type="button" onclick="closeAppt()">Cancel</button>
      </div>
    </form>

    <div style="margin-top:10px;">
      <button class="btn danger" type="button" id="deleteAppt">Delete Appointment</button>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<script>
const modal = document.getElementById("apptModal");
function closeAppt(){ modal.classList.remove("show"); }
function openAppt(data){
  document.getElementById("appt_id").value = data.id || "";
  if(data.ro_id) document.getElementById("ro_id").value = data.ro_id;
  document.getElementById("title").value = data.title || "";
  document.getElementById("start_at").value = data.start_at || "";
  document.getElementById("end_at").value = data.end_at || "";
  document.getElementById("status").value = data.status || "scheduled";
  document.getElementById("notes").value = data.notes || "";
  modal.classList.add("show");
}

function formatForInput(date){
  if(!date) return "";
  const d = new Date(date);
  return d.toISOString().slice(0,16);
}

async function getEvents(info){
  const r = await fetch(`/api/appointments?start=${encodeURIComponent(info.startStr)}&end=${encodeURIComponent(info.endStr)}`);
  return await r.json();
}

document.addEventListener('DOMContentLoaded', async function() {
  const el = document.getElementById('calendar');
  const cal = new FullCalendar.Calendar(el, {
    initialView: 'dayGridMonth',
    height: 'auto',
    selectable: true,
    events: async (info, success, failure)=>{
      try { success(await getEvents(info)); } catch(e){ failure(e); }
    },
    dateClick: (info)=>{
      const start = info.dateStr + "T09:00";
      const end = info.dateStr + "T10:00";
      openAppt({start_at:start, end_at:end, status:"scheduled"});
    },
    eventClick: (info)=>{
      fetch(`/api/calendar/event/${encodeURIComponent(info.event.id)}`)
        .then((r)=>r.json())
        .then((data)=>openAppt({
          id: data.id,
          title: data.title,
          ro_id: data.ro_id,
          status: data.status,
          notes: data.notes,
          start_at: formatForInput(data.start_at),
          end_at: formatForInput(data.end_at),
        }));
      const data = {
        id: info.event.id,
        title: info.event.title,
        ro_id: info.event.extendedProps.ro_id,
        status: info.event.extendedProps.status,
        notes: info.event.extendedProps.notes,
        start_at: formatForInput(info.event.start),
        end_at: formatForInput(info.event.end),
      };
      openAppt(data);
    }
  });
  cal.render();
  document.getElementById("apptForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const apptId = document.getElementById("appt_id").value;
    const form = new FormData(e.target);
    if(apptId){
      await fetch(`/api/calendar/appointments/${encodeURIComponent(apptId)}/update`, {method:"POST", body:form});
    }else{
      await fetch("/api/calendar/appointments", {method:"POST", body:form});
      await fetch(`/api/appointments/${encodeURIComponent(apptId)}/update`, {method:"POST", body:form});
    }else{
      await fetch("/api/appointments", {method:"POST", body:form});
    }
    closeAppt();
    cal.refetchEvents();
  });
  document.getElementById("deleteAppt").addEventListener("click", async ()=>{
    const apptId = document.getElementById("appt_id").value;
    if(!apptId) return;
    await fetch(`/api/calendar/appointments/${encodeURIComponent(apptId)}/delete`, {method:"POST"});
    await fetch(`/api/appointments/${encodeURIComponent(apptId)}/delete`, {method:"POST"});
    closeAppt();
    cal.refetchEvents();
  });
});
modal.addEventListener("click", (e)=>{ if(e.target===modal) closeAppt(); });
</script>
{% endblock %}
