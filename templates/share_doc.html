{% set t = (doc.doc_type|capitalize) ~ " Share" %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ t }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="topbar">
    <div class="brand">RoCo Auto</div>
    <div class="nav">
      <a href="{{ pdf_url }}" class="pilllink" target="_blank">Download PDF</a>
    </div>
  </div>

  <div class="container">
    <div class="card share-hero">
      <div class="share-top-bubble">
      <div class="share-meta">
        <div class="share-info">
          <span class="muted small">RO #{{ ro.ro_number }}</span>
          <span class="muted small">{{ customer.name }}</span>
          <span class="muted small">{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }} {{ vehicle.engine }}</span>
        </div>
      </div>
    </div>

    {% if jobs %}
      <div class="share-jobs">
        {% for j in jobs %}
          <div class="card share-job-card">
            <div class="share-job-top">
              <div>
                <div class="share-job-title">{{ j.title }}</div>
                {% set status_class = 'pill ok' if j.status=='approved' else 'pill danger' if j.status=='declined' else 'pill' %}
                <div class="muted small">Status: <span class="{{ status_class }}">{{ j.status }}</span></div>
              </div>
              <div class="share-job-total">
                <div class="muted small">Job total</div>
                <div class="big">${{ job_totals.get(j.id, '0.00') }}</div>
              </div>
            </div>
            {% if doc.doc_type == 'estimate' %}
              <div class="share-job-actions">
                <form method="post" action="{{ url_for('share_job_status', token=doc.share_token, job_id=j.id) }}">
                  <input type="hidden" name="status" value="approved">
                  <button class="btn good small" type="submit">Approve</button>
                </form>
                <form method="post" action="{{ url_for('share_job_status', token=doc.share_token, job_id=j.id) }}">
                  <input type="hidden" name="status" value="declined">
                  <button class="btn danger small" type="submit">Decline</button>
                </form>
              </div>
            {% endif %}
            <table class="table share-items">
              <tr><th>Description</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Amount</th></tr>
              {% for it in items_by_job.get(j.id, []) %}
                {% set amt = ((it.qty or 0) * (it.unit_price or 0)) %}
                <tr>
                  <td>
                    <div>{{ it.description }}</div>
                    <div class="muted">{{ it.item_type }}{% if it.labor_hours %} • {{ it.labor_hours }}h{% endif %}</div>
                  </td>
                  <td class="right">{{ it.qty }}</td>
                  <td class="right">${{ it.unit_price }}</td>
                  <td class="right">
                    {% if it.item_type=='discount' %}
                      -${{ (amt|abs) | round(2) }}
                    {% else %}
                      ${{ amt | round(2) }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </table>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% if unassigned_items %}
      <div class="card">
        <div class="cardtitle">Additional items</div>
        <table class="table share-items">
          <tr><th>Description</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Amount</th></tr>
          {% for it in unassigned_items %}
            {% set amt = ((it.qty or 0) * (it.unit_price or 0)) %}
            <tr>
              <td>
                <div>{{ it.description }}</div>
                <div class="muted">{{ it.item_type }}{% if it.labor_hours %} • {{ it.labor_hours }}h{% endif %}</div>
              </td>
              <td class="right">{{ it.qty }}</td>
              <td class="right">${{ it.unit_price }}</td>
              <td class="right">
                {% if it.item_type=='discount' %}
                  -${{ (amt|abs) | round(2) }}
                {% else %}
                  ${{ amt | round(2) }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endif %}

    {% if not jobs and not unassigned_items %}
      <div class="card">
        <div class="cardtitle">Line items</div>
        <table class="table share-items">
          <tr><th>Description</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Amount</th></tr>
          {% for it in items %}
            {% set amt = ((it.qty or 0) * (it.unit_price or 0)) %}
            <tr>
              <td>
                <div>{{ it.description }}</div>
                <div class="muted">{{ it.item_type }}{% if it.labor_hours %} • {{ it.labor_hours }}h{% endif %}</div>
              </td>
              <td class="right">{{ it.qty }}</td>
              <td class="right">${{ it.unit_price }}</td>
              <td class="right">
                {% if it.item_type=='discount' %}
                  -${{ (amt|abs) | round(2) }}
                {% else %}
                  ${{ amt | round(2) }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endif %}


    {% if not jobs and not unassigned_items %}
      <div class="card">
        <div class="cardtitle">Line items</div>
        <table class="table share-items">
          <tr><th>Description</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Amount</th></tr>
          {% for it in items %}
            {% set amt = ((it.qty or 0) * (it.unit_price or 0)) %}
            <tr>
              <td>
                <div>{{ it.description }}</div>
                <div class="muted">{{ it.item_type }}{% if it.labor_hours %} • {{ it.labor_hours }}h{% endif %}</div>
              </td>
              <td class="right">{{ it.qty }}</td>
              <td class="right">${{ it.unit_price }}</td>
              <td class="right">
                {% if it.item_type=='discount' %}
                  -${{ (amt|abs) | round(2) }}
                {% else %}
                  ${{ amt | round(2) }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endif %}

    <div class="card share-totals">
      <div class="totals">
        <div><span class="muted">Subtotal</span><div class="big">${{ doc.subtotal }}</div></div>
        <div><span class="muted">Tax</span><div class="big">${{ doc.tax }}</div></div>
        <div class="total"><span>Total</span><div class="big">${{ doc.total }}</div></div>

    {% if unassigned_items %}
      <div class="card">
        <div class="cardtitle">Additional items</div>
        <table class="table share-items">
          <tr><th>Description</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Amount</th></tr>
          {% for it in unassigned_items %}
            {% set amt = ((it.qty or 0) * (it.unit_price or 0)) %}
            <tr>
              <td>
                <div>{{ it.description }}</div>
                <div class="muted">{{ it.item_type }}{% if it.labor_hours %} • {{ it.labor_hours }}h{% endif %}</div>
              </td>
              <td class="right">{{ it.qty }}</td>
              <td class="right">${{ it.unit_price }}</td>
              <td class="right">
                {% if it.item_type=='discount' %}
                  -${{ (amt|abs) | round(2) }}
                {% else %}
                  ${{ amt | round(2) }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endif %}

    {% if not jobs and not unassigned_items %}
      <div class="card">
        <div class="cardtitle">Line items</div>
        <table class="table share-items">
          <tr><th>Description</th><th class="right">Qty</th><th class="right">Unit</th><th class="right">Amount</th></tr>
          {% for it in items %}
            {% set amt = ((it.qty or 0) * (it.unit_price or 0)) %}
            <tr>
              <td>
                <div>{{ it.description }}</div>
                <div class="muted">{{ it.item_type }}{% if it.labor_hours %} • {{ it.labor_hours }}h{% endif %}</div>
              </td>
              <td class="right">{{ it.qty }}</td>
              <td class="right">${{ it.unit_price }}</td>
              <td class="right">
                {% if it.item_type=='discount' %}
                  -${{ (amt|abs) | round(2) }}
                {% else %}
                  ${{ amt | round(2) }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endif %}
  </div>
</body>
</html>
